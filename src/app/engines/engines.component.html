<div class="content">
    <!-- Mode Toggle with basic buttons -->
    <div class="view-mode-toggle" style="margin-bottom: 20px;">
        <button mat-raised-button [color]="viewMode === 'instance' ? 'primary' : 'basic'"
            (click)="switchToInstanceView()">
            Instance View
        </button>
        <button mat-raised-button [color]="viewMode === 'aggregation' ? 'primary' : 'basic'"
            (click)="switchToAggregationView('')" style="margin-left: 10px;">
            Aggregation View
        </button>
    </div>

    <!-- Instance View Section -->
    <div *ngIf="viewMode === 'instance'">
        <!-- Existing instance search and controls -->
        <div class="search-section">
            <mat-form-field appearance="outline">
                <mat-label>Process Instance ID</mat-label>
                <input matInput #instanceInput placeholder="Enter instance ID">
            </mat-form-field>
            <button mat-raised-button color="primary" (click)="onSearch(instanceInput.value)"
                style="margin-left: 10px;">
                Search Instance
            </button>
            <button mat-raised-button color="warn" *ngIf="currentProcessId" (click)="onDeleteProcess()"
                style="margin-left: 10px;">
                Delete Process
            </button>
        </div>
    </div>

    <!-- Aggregation View Section -->
    <div *ngIf="viewMode === 'aggregation' && currentProcessType" class="aggregation-summary">
        <h4>Summary for {{currentProcessType}}</h4>
        <div class="summary-cards">
            <mat-card class="summary-card">
                <mat-card-content>
                    <h3>{{aggregationSummary.overall?.totalInstances || 0}}</h3>
                    <p>Total Instances</p>
                </mat-card-content>
            </mat-card>
            <mat-card class="summary-card">
                <mat-card-content>
                    <h3>{{(aggregationSummary.overall?.averageDeviationRate || 0) | number:'1.1-1'}}%</h3>
                    <p>Average Deviation Rate</p>
                </mat-card-content>
            </mat-card>
            <mat-card class="summary-card">
                <mat-card-content>
                    <h3>{{aggregationSummary.overall?.totalDeviations || 0}}</h3>
                    <p>Total Deviations</p>
                </mat-card-content>
            </mat-card>
            <mat-card class="summary-card">
                <mat-card-content>
                    <h3>{{aggregationSummary.perspectives?.length || 0}}</h3>
                    <p>Perspectives</p>
                </mat-card-content>
            </mat-card>
        </div>
    </div>

    <!-- Results Section (Common for both views) -->
    <div *ngIf="isResult">
        <!-- Engine List (only for instance view) -->
        <app-engine-list #engines *ngIf="viewMode === 'instance'"></app-engine-list>

        <!-- BPMN Diagrams -->
        <div class="diagram-section" *ngIf="diagramPerspectives.length > 0">
            <h4 *ngIf="viewMode === 'aggregation'">
                Aggregated View - {{currentProcessType}}
            </h4>
            <h4 *ngIf="viewMode === 'instance'">
                Instance View - {{currentProcessId}}
            </h4>

            <!-- Simple tab implementation -->
            <div class="simple-tabs">
                <div class="tab-headers">
                    <button *ngFor="let perspective of diagramPerspectives; let i = index" class="tab-header"
                        [class.active]="i === 0" (click)="selectTab(i)">
                        {{perspective.name}}
                    </button>
                </div>

                <div class="tab-content">
                    <div *ngFor="let perspective of diagramPerspectives; let i = index"
                        [style.display]="i === 0 ? 'block' : 'none'" class="tab-panel">

                        <!-- Perspective-specific summary for aggregation view -->
                        <div *ngIf="viewMode === 'aggregation' && aggregationSummary" class="perspective-summary">
                            <ng-container *ngFor="let perspSummary of aggregationSummary.perspectives">
                                <div *ngIf="perspSummary.perspective === perspective.name" class="perspective-stats">
                                    <div class="stat-chips">
                                        <span class="stat-chip"
                                            [ngClass]="'severity-' + getSeverityClass(perspSummary.averageDeviationRate)">
                                            {{(perspSummary.averageDeviationRate || 0) | number:'1.1-1'}}% avg deviation
                                            rate
                                        </span>
                                        <span class="stat-chip">
                                            {{perspSummary.stagesWithDeviations}}/{{perspSummary.totalStages}} stages
                                            affected
                                        </span>
                                        <span class="stat-chip">
                                            {{perspSummary.instancesWithDeviations}} instances with deviations
                                        </span>
                                    </div>
                                </div>
                            </ng-container>
                        </div>

                        <app-bpmn #bpmn_diagrams [model_xml]="perspective.bpmn_xml" [model_id]="perspective.name"
                            [show_statistics]="false" (DiagramEventEmitter)="onDiagramEvent($event)">
                        </app-bpmn>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>